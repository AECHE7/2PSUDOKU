services:
  - type: web
    name: 2psudoku
    env: python
    buildCommand: ./build.sh
    startCommand: ./start_server.sh
    envVars:
      - key: PYTHON_VERSION
        value: 3.13.0
      - key: DATABASE_URL
        fromDatabase:
          name: postgres
          property: connectionString
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings
    release:
      command: |
        # Run migrations first
        python manage.py migrate --noinput
        
        # Verify migrations explicitly
        python manage.py showmigrations game
        
        # Run our validation command
        python manage.py validate_migrations
        
        # Double-check the specific column
        python -c "
import os
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
import django; django.setup()
from django.db import connection
with connection.cursor() as cursor:
    cursor.execute('''
        SELECT EXISTS (
            SELECT FROM information_schema.columns 
            WHERE table_name = 'game_gameresult' 
            AND column_name = 'result_type'
        );
    ''')
    if not cursor.fetchone()[0]:
        raise Exception('result_type column is missing - migrations did not apply correctly')
        "