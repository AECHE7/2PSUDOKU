{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
  /* Game Layout */
  .game-layout {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 20px;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  /* Top Navigation Bar */
  .top-nav {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 0;
    margin: -20px -20px 20px -20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .nav-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .game-title {
    font-size: 1.5rem;
    font-weight: bold;
    margin: 0;
  }

  .nav-actions {
    display: flex;
    gap: 10px;
  }

  .nav-btn {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
  }

  .nav-btn:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-1px);
  }

  /* Interactive Sudoku Grid */
  .sudoku-container {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    position: relative;
  }

  .sudoku-grid {
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    border-collapse: separate;
    border-spacing: 2px;
    background: #2c3e50;
    border-radius: 8px;
    overflow: hidden;
  }

  .sudoku-cell {
    width: 11.11%;
    height: 50px;
    padding: 0;
    background: white;
    position: relative;
    border: none;
  }

  .sudoku-cell:nth-child(3n) {
    border-right: 3px solid #2c3e50;
  }

  .sudoku-cell:nth-child(6n) {
    border-right: 3px solid #2c3e50;
  }

  .sudoku-row:nth-child(3n) .sudoku-cell {
    border-bottom: 3px solid #2c3e50;
  }

  .sudoku-row:nth-child(6n) .sudoku-cell {
    border-bottom: 3px solid #2c3e50;
  }

  .cell-input {
    width: 100%;
    height: 50px;
    border: none;
    text-align: center;
    font-size: 1.4rem;
    font-weight: bold;
    background: transparent;
    transition: all 0.3s ease;
    outline: none;
    cursor: pointer;
  }

  .cell-input:hover {
    background-color: #e3f2fd;
  }

  .cell-input:focus {
    background-color: #bbdefb;
    box-shadow: inset 0 0 0 2px #2196f3;
  }

  .cell-input.selected {
    background-color: #2196f3 !important;
    color: white;
  }

  .cell-input.highlighted {
    background-color: #fff3e0;
  }

  .cell-input.prefilled {
    background-color: #f5f5f5;
    color: #333;
    font-weight: 900;
  }

  .cell-input.correct {
    background-color: #e8f5e8;
    color: #2e7d32;
    animation: correctPulse 0.5s ease;
  }

  .cell-input.incorrect {
    background-color: #ffebee;
    color: #c62828;
    animation: incorrectShake 0.5s ease;
  }

  .cell-input.game-finished {
    background-color: #e8f5e8;
    border-color: #28a745;
  }

  /* Opponent Board Styling */
  .opponent-board {
    transform: scale(0.6);
    opacity: 0.8;
    margin: -60px auto -40px auto;
  }

  .opponent-cell {
    background-color: #f8f9fa;
    color: #6c757d;
    font-size: 1rem;
    cursor: not-allowed;
  }

  .opponent-cell.filled {
    background-color: #e3f2fd;
    color: #1976d2;
    font-weight: bold;
  }

  .board-section {
    position: relative;
  }

  @keyframes opponentMove {
    0% { background-color: #fff3cd; transform: scale(1); }
    50% { background-color: #ffc107; transform: scale(1.1); }
    100% { background-color: #e3f2fd; transform: scale(1); }
  }

  @keyframes correctPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }

  @keyframes incorrectShake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  /* Number Pad */
  .number-pad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 20px;
  }

  .number-btn {
    height: 50px;
    border: 2px solid #e0e0e0;
    background: white;
    font-size: 1.2rem;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .number-btn:hover {
    border-color: #2196f3;
    background: #e3f2fd;
    transform: translateY(-2px);
  }

  .number-btn.active {
    background: #2196f3;
    color: white;
    border-color: #1976d2;
  }

  .number-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(33, 150, 243, 0.3);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.3s ease, height 0.3s ease;
  }

  .number-btn:active::before {
    width: 100px;
    height: 100px;
  }

  /* Statistics Panel */
  .stats-panel {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  }

  .stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .stat-item:last-child {
    border-bottom: none;
  }

  .stat-label {
    font-weight: 600;
    color: #666;
  }

  .stat-value {
    font-size: 1.1rem;
    font-weight: bold;
    color: #333;
  }

  .stat-value.time {
    color: #2196f3;
    font-family: 'Courier New', monospace;
  }

  .stat-value.mistakes {
    color: #f44336;
  }

  .stat-value.difficulty {
    color: #ff9800;
    text-transform: capitalize;
  }

  /* Messages */
  .message.success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
    padding: 8px 12px;
    border-radius: 4px;
    margin: 2px 0;
  }

  .message.info {
    color: #0c5460;
    background-color: #d1ecf1;
    border-color: #bee5eb;
    padding: 8px 12px;
    border-radius: 4px;
    margin: 2px 0;
  }

  .message.error {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
    padding: 8px 12px;
    border-radius: 4px;
    margin: 2px 0;
  }

  /* Modal */
  .modal-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .game-layout {
      grid-template-columns: 1fr;
      gap: 15px;
      padding: 10px;
    }

    .nav-content {
      flex-direction: column;
      gap: 10px;
      text-align: center;
    }

    .sudoku-grid {
      max-width: 350px;
    }

    .cell-input {
      height: 40px;
      font-size: 1.2rem;
    }

    .sudoku-cell {
      height: 40px;
    }

    .number-pad {
      grid-template-columns: repeat(5, 1fr);
    }

    .number-btn {
      height: 45px;
      font-size: 1.1rem;
    }
  }

  @media (max-width: 480px) {
    .sudoku-grid {
      max-width: 300px;
    }

    .cell-input, .sudoku-cell {
      height: 35px;
      font-size: 1rem;
    }

    .number-btn {
      height: 40px;
      font-size: 1rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Top Navigation Bar -->
<div class="top-nav">
  <div class="nav-content">
    <h1 class="game-title">üèÅ Sudoku Race: {{ game.code }}</h1>
    <div class="nav-actions">
      <button class="nav-btn" onclick="copyGameCode()">üìã Copy Code</button>
      <button class="nav-btn" onclick="showRules()">‚ùì Rules</button>
      <button class="nav-btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
    </div>
  </div>
</div>

<!-- Main Game Layout -->
<div class="game-layout">
  <!-- Left Panel: Game Board -->
  <div class="sudoku-container">
    <!-- Players Header -->
    <div class="players-header mb-3 d-flex justify-content-between align-items-center">
      <div class="player {% if is_player1 %}current-player{% endif %} text-center">
        <h5>{{ game.player1.username }}</h5>
        <div class="player-timer" id="player1-timer">00:00</div>
        <small class="player-status">{% if is_player1 %}You{% else %}Opponent{% endif %}</small>
      </div>
      
      <div class="vs h4 mb-0">VS</div>
      
      <div class="player {% if is_player2 %}current-player{% endif %} text-center">
        {% if game.player2 %}
          <h5>{{ game.player2.username }}</h5>
          <div class="player-timer" id="player2-timer">00:00</div>
          <small class="player-status">{% if is_player2 %}You{% else %}Opponent{% endif %}</small>
        {% else %}
          <h5>Waiting...</h5>
          <div class="player-timer">--:--</div>
          <small class="player-status">Waiting for player...</small>
        {% endif %}
      </div>
    </div>

    <!-- Player's Interactive Sudoku Grid -->
    <div class="board-section">
      <h6 class="text-center mb-2">Your Board</h6>
      {% if board %}
        <table class="sudoku-grid" id="player-board">
          <tbody>
            {% for row in board %}
              <tr class="sudoku-row">
                {% for cell in row %}
                  <td class="sudoku-cell" data-row="{{ forloop.parentloop.counter0 }}" data-col="{{ forloop.counter0 }}">
                    {% if cell != 0 %}
                      <input type="number" min="1" max="9" class="cell-input prefilled" value="{{ cell }}" disabled readonly 
                             aria-label="Prefilled cell row {{ forloop.parentloop.counter }} column {{ forloop.counter }}" 
                             tabindex="-1">
                    {% else %}
                      <input type="number" min="1" max="9" class="cell-input" 
                             data-row="{{ forloop.parentloop.counter0 }}" data-col="{{ forloop.counter0 }}"
                             aria-label="Empty cell row {{ forloop.parentloop.counter }} column {{ forloop.counter }}"
                             placeholder="" autocomplete="off">
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="loading-board text-center py-5">
          <p class="h5">üé≤ Loading puzzle...</p>
        </div>
      {% endif %}
    </div>

    <!-- Opponent's Board Preview (Read-only) -->
    <div class="board-section mt-4">
      <h6 class="text-center mb-2">Opponent's Progress</h6>
      <table class="sudoku-grid opponent-board" id="opponent-board">
        <tbody>
          {% for row in board %}
            <tr class="sudoku-row">
              {% for cell in row %}
                <td class="sudoku-cell">
                  {% if cell != 0 %}
                    <input type="number" class="cell-input prefilled opponent-cell" value="{{ cell }}" disabled readonly
                           aria-label="Opponent prefilled cell row {{ forloop.parentloop.counter }} column {{ forloop.counter }}"
                           tabindex="-1">
                  {% else %}
                    <input type="number" class="cell-input opponent-cell" disabled readonly
                           aria-label="Opponent empty cell row {{ forloop.parentloop.counter }} column {{ forloop.counter }}"
                           tabindex="-1">
                  {% endif %}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Number Pad -->
    <div class="number-pad">
      <button class="number-btn" data-number="1">1</button>
      <button class="number-btn" data-number="2">2</button>
      <button class="number-btn" data-number="3">3</button>
      <button class="number-btn" data-number="4">4</button>
      <button class="number-btn" data-number="5">5</button>
      <button class="number-btn" data-number="6">6</button>
      <button class="number-btn" data-number="7">7</button>
      <button class="number-btn" data-number="8">8</button>
      <button class="number-btn" data-number="9">9</button>
    </div>

    <!-- Game Controls -->
    <div class="game-controls mt-3">
      <div class="race-controls text-center">
        <button id="ready-btn" class="btn btn-primary" style="display: none;">I'm Ready!</button>
        <button id="finish-btn" class="btn btn-warning" style="display: none;">Submit Solution!</button>
      </div>
    </div>
  </div>

  <!-- Right Panel: Statistics & Messages -->
  <div class="stats-panel">
    <h5>üìä Game Statistics</h5>
    
    <div class="stat-item">
      <span class="stat-label">‚è±Ô∏è Elapsed Time</span>
      <span class="stat-value time" id="elapsed-time">00:00</span>
    </div>
    
    <div class="stat-item">
      <span class="stat-label">‚ùå Mistakes</span>
      <span class="stat-value mistakes" id="mistake-count">0</span>
    </div>
    
    <div class="stat-item">
      <span class="stat-label">üéØ Difficulty</span>
      <span class="stat-value difficulty">{{ game.difficulty }}</span>
    </div>
    
    <div class="stat-item">
      <span class="stat-label">üìç Status</span>
      <span class="stat-value" id="game-status">
        {% if game.status == 'waiting' %}‚è≥ Waiting
        {% elif game.status == 'ready' %}‚úÖ Ready
        {% else %}üèÅ Racing{% endif %}
      </span>
    </div>

    <div class="stat-item">
      <span class="stat-label">üî¢ Cells Filled</span>
      <span class="stat-value" id="cells-filled">0/81</span>
    </div>

    <!-- Messages -->
    <div class="mt-4">
      <h6>üí¨ Game Messages</h6>
      <div id="messages" class="messages-container" style="max-height: 200px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem;"></div>
    </div>
  </div>
</div>

<!-- Winner Modal -->
<div id="winner-modal" class="modal fade" tabindex="-1" aria-labelledby="winnerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="winnerModalLabel">üéâ Game Over!</h5>
      </div>
      <div class="modal-body text-center">
        <div id="winner-content">
          <!-- Winner content will be populated by JavaScript -->
        </div>
        <div class="mt-3">
          <h6>Game Statistics:</h6>
          <div id="game-stats">
            <!-- Game stats will be populated by JavaScript -->
          </div>
        </div>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-primary" id="play-again-btn">Play Again</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="game-data" 
  data-game-code="{{ game.code }}"
  data-player-id="{{ user.id }}"
  data-player1-id="{{ game.player1.id }}"
  data-player2-id="{{ game.player2.id|default:'' }}"
  data-difficulty="{{ game.difficulty }}"
  data-is-player1="{% if is_player1 %}true{% else %}false{% endif %}"
  data-is-player2="{% if is_player2 %}true{% else %}false{% endif %}"
  data-game-status="{{ game.status }}"
  style="display: none;"></div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'game/game_board.js' %}"></script>
{% endblock %}
