{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
  .cell-input.game-finished {
    background-color: #e8f5e8;
    border-color: #28a745;
  }

  .message.success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
    padding: 8px 12px;
    border-radius: 4px;
    margin: 2px 0;
  }

  .message.info {
    color: #0c5460;
    background-color: #d1ecf1;
    border-color: #bee5eb;
    padding: 8px 12px;
    border-radius: 4px;
    margin: 2px 0;
  }

  .modal-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
  }

  .game-finished-overlay {
    position: relative;
  }

  .game-finished-overlay::after {
    content: 'üéâ';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2em;
    pointer-events: none;
  }
</style>
{% endblock %}

{% block content %}
<h1>üèÅ Sudoku Race: {{ game.code }}</h1>

<div class="game-header">
  <div class="game-info">
    <div class="players">
      <div class="player {% if is_player1 %}current-player{% endif %}">
        <h3>{{ game.player1.username }}</h3>
        <div class="player-timer" id="player1-timer">00:00</div>
        <div class="player-status" id="player1-status">{% if is_player1 %}You{% else %}Opponent{% endif %}</div>
      </div>
      
      <div class="vs">VS</div>
      
      <div class="player {% if is_player2 %}current-player{% endif %}">
        {% if game.player2 %}
          <h3>{{ game.player2.username }}</h3>
          <div class="player-timer" id="player2-timer">00:00</div>
          <div class="player-status" id="player2-status">{% if is_player2 %}You{% else %}Opponent{% endif %}</div>
        {% else %}
          <h3>Waiting...</h3>
          <div class="player-timer">--:--</div>
          <div class="player-status">Joining...</div>
        {% endif %}
      </div>
    </div>
    
    <div class="game-meta">
      <p><strong>Difficulty:</strong> <span class="difficulty-{{ game.difficulty }}">{{ game.get_difficulty_display }}</span></p>
      <p><strong>Status:</strong> <span id="game-status">{{ game.get_status_display }}</span></p>
      <p><strong>Room Code:</strong> <code>{{ game.code }}</code></p>
    </div>
  </div>
</div>

<div id="game-container">
  {% if board %}
    <table class="sudoku-grid">
      <tbody>
        {% for row in board %}
          <tr>
            {% for cell in row %}
              <td class="sudoku-cell" data-row="{{ forloop.parentloop.counter0 }}" data-col="{{ forloop.counter0 }}">
                {% if cell != 0 %}
                  <input type="number" min="1" max="9" class="cell-input prefilled" value="{{ cell }}" disabled>
                {% else %}
                  <input type="number" min="1" max="9" class="cell-input">
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="error">Unable to load board. Refreshing...</p>
  {% endif %}
</div>

<div id="messages"></div>

<div class="game-controls">
  <div id="game-messages"></div>
  <div class="race-controls">
    <button id="ready-btn" class="btn btn-primary" style="display: none;">I'm Ready!</button>
    <button id="finish-btn" class="btn btn-warning" style="display: none;">Submit Solution!</button>
  </div>
</div>

<!-- Winner Modal -->
<div id="winner-modal" class="modal fade" tabindex="-1" aria-labelledby="winnerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="winnerModalLabel">üéâ Game Over!</h5>
      </div>
      <div class="modal-body text-center">
        <div id="winner-content">
          <!-- Winner content will be populated by JavaScript -->
        </div>
        <div class="mt-3">
          <h6>Game Statistics:</h6>
          <div id="game-stats">
            <!-- Game stats will be populated by JavaScript -->
          </div>
        </div>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-primary" id="play-again-btn">Play Again</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="game-data" 
  data-game-code="{{ game.code }}"
  data-player-id="{{ user.id }}"
  data-player1-id="{{ game.player1.id }}"
  data-player2-id="{{ game.player2.id|default:'' }}"
  data-difficulty="{{ game.difficulty }}"
  data-is-player1="{% if is_player1 %}true{% else %}false{% endif %}"
  data-is-player2="{% if is_player2 %}true{% else %}false{% endif %}"
  data-game-status="{{ game.status }}"
  style="display: none;"></div>

<script src="{% static 'game/game_board.js' %}"></script>
{% endblock %}
